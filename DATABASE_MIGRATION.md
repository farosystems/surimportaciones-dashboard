# üìä Esquema Completo de Base de Datos - Cat√°logo Sur Importaciones

Este documento contiene toda la informaci√≥n necesaria para migrar y recrear la base de datos completa del sistema de cat√°logo y financiaci√≥n.

## üìã √çndice

1. [Extensiones y Configuraci√≥n](#extensiones-y-configuraci√≥n)
2. [Tablas Principales](#tablas-principales)
3. [√çndices](#√≠ndices)
4. [Funciones y Triggers](#funciones-y-triggers)
5. [Row Level Security (RLS)](#row-level-security-rls)
6. [Pol√≠ticas de Seguridad](#pol√≠ticas-de-seguridad)
7. [Storage Buckets](#storage-buckets)
8. [Datos de Ejemplo](#datos-de-ejemplo)

---

## üîß Extensiones y Configuraci√≥n

```sql
-- Habilitar extensiones necesarias
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

---

## üìä Tablas Principales

### 1. **categorias**
Tabla para las categor√≠as de productos.

```sql
CREATE TABLE public.categorias (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    
    constraint categorias_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n (autom√°tica)
- `descripcion` (TEXT): Nombre de la categor√≠a

---

### 2. **marcas**
Tabla para las marcas de productos.

```sql
CREATE TABLE public.marcas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    logo text null,
    
    constraint marcas_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n (autom√°tica)
- `descripcion` (TEXT): Nombre de la marca
- `logo` (TEXT, NULLABLE): URL del logo de la marca

---

### 3. **productos**
Tabla principal de productos con m√∫ltiples campos de imagen y configuraciones.

```sql
CREATE TABLE public.productos (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    descripcion_detallada text null,
    precio numeric(10,2) not null,
    imagen text null,
    imagen_2 text null,
    imagen_3 text null,
    imagen_4 text null,
    imagen_5 text null,
    destacado boolean default false,
    activo boolean default true,
    aplica_todos_plan boolean default false,
    aplica_solo_categoria boolean default false,
    aplica_plan_especial boolean default false,
    fk_id_categoria bigint null,
    fk_id_marca bigint null,
    
    constraint productos_pkey primary key (id),
    constraint productos_fk_id_categoria_fkey foreign key (fk_id_categoria) 
        references public.categorias (id) on delete set null,
    constraint productos_fk_id_marca_fkey foreign key (fk_id_marca) 
        references public.marcas (id) on delete set null
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n (autom√°tica)
- `descripcion` (TEXT): Nombre del producto
- `descripcion_detallada` (TEXT, NULLABLE): Descripci√≥n extendida con HTML
- `precio` (NUMERIC): Precio del producto
- `imagen` (TEXT, NULLABLE): URL de imagen principal
- `imagen_2` a `imagen_5` (TEXT, NULLABLE): URLs de im√°genes adicionales
- `destacado` (BOOLEAN): Producto destacado
- `activo` (BOOLEAN): Producto activo/inactivo
- `aplica_todos_plan` (BOOLEAN): Se incluye en todos los planes autom√°ticamente
- `aplica_solo_categoria` (BOOLEAN): Solo se incluye seg√∫n categor√≠a
- `aplica_plan_especial` (BOOLEAN): Requiere configuraci√≥n especial
- `fk_id_categoria` (BIGINT, FK): Referencia a categor√≠a
- `fk_id_marca` (BIGINT, FK): Referencia a marca

---

### 4. **planes_financiacion**
Tabla de planes de financiaci√≥n.

```sql
CREATE TABLE public.planes_financiacion (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    updated_at timestamp with time zone not null default now(),
    nombre text not null,
    cuotas integer not null,
    recargo_porcentual numeric(5,2) null,
    recargo_fijo numeric(10,2) null,
    monto_minimo numeric(10,2) not null,
    monto_maximo numeric(10,2) null,
    anticipo_minimo numeric(5,2) null,
    anticipo_minimo_fijo numeric(10,2) null,
    activo boolean default true,
    
    constraint planes_financiacion_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `updated_at` (TIMESTAMPTZ): Fecha de √∫ltima actualizaci√≥n
- `nombre` (TEXT): Nombre del plan
- `cuotas` (INTEGER): N√∫mero de cuotas
- `recargo_porcentual` (NUMERIC, NULLABLE): Recargo en porcentaje
- `recargo_fijo` (NUMERIC, NULLABLE): Recargo fijo en pesos
- `monto_minimo` (NUMERIC): Monto m√≠nimo para aplicar el plan
- `monto_maximo` (NUMERIC, NULLABLE): Monto m√°ximo del plan
- `anticipo_minimo` (NUMERIC, NULLABLE): Anticipo m√≠nimo en porcentaje
- `anticipo_minimo_fijo` (NUMERIC, NULLABLE): Anticipo m√≠nimo fijo
- `activo` (BOOLEAN): Plan activo/inactivo

---

### 5. **planes_categorias**
Tabla intermedia para relaci√≥n muchos-a-muchos entre planes y categor√≠as.

```sql
CREATE TABLE public.planes_categorias (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_plan bigint not null,
    fk_id_categoria bigint not null,
    
    constraint planes_categorias_pkey primary key (id),
    constraint planes_categorias_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint planes_categorias_fk_id_categoria_fkey foreign key (fk_id_categoria) 
        references public.categorias (id) on delete cascade,
    constraint planes_categorias_unique unique (fk_id_plan, fk_id_categoria)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiaci√≥n
- `fk_id_categoria` (BIGINT, FK): Referencia a categor√≠a

---

### 6. **productos_planes**
Tabla para productos configurados manualmente en planes espec√≠ficos.

```sql
CREATE TABLE public.productos_planes (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_producto bigint not null,
    fk_id_plan bigint not null,
    activo boolean default true,
    destacado boolean default false,
    
    constraint productos_planes_pkey primary key (id),
    constraint productos_planes_fk_id_producto_fkey foreign key (fk_id_producto) 
        references public.productos (id) on delete cascade,
    constraint productos_planes_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint productos_planes_unique unique (fk_id_producto, fk_id_plan)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `fk_id_producto` (BIGINT, FK): Referencia a producto
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiaci√≥n
- `activo` (BOOLEAN): Relaci√≥n activa/inactiva
- `destacado` (BOOLEAN): Producto destacado en el plan

---

### 7. **productos_planes_default**
Tabla de respaldo para asociaciones autom√°ticas por reglas.

```sql
CREATE TABLE public.productos_planes_default (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_producto bigint not null,
    fk_id_plan bigint not null,
    activo boolean default true,
    
    constraint productos_planes_default_pkey primary key (id),
    constraint productos_planes_default_fk_id_producto_fkey foreign key (fk_id_producto) 
        references public.productos (id) on delete cascade,
    constraint productos_planes_default_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint productos_planes_default_unique unique (fk_id_producto, fk_id_plan)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `fk_id_producto` (BIGINT, FK): Referencia a producto
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiaci√≥n
- `activo` (BOOLEAN): Asociaci√≥n activa/inactiva

---

### 8. **zonas**
Tabla para zonas geogr√°ficas.

```sql
CREATE TABLE public.zonas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    nombre text null,
    
    constraint zonas_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `nombre` (TEXT, NULLABLE): Nombre de la zona

---

### 9. **configuracion**
Tabla de configuraci√≥n general del sistema.

```sql
CREATE TABLE public.configuracion (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    telefono text null,
    
    constraint configuracion_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `telefono` (TEXT, NULLABLE): Tel√©fono general

---

### 10. **configuracion_zonas**
Tabla de configuraci√≥n espec√≠fica por zona.

```sql
CREATE TABLE public.configuracion_zonas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_zona bigint not null,
    telefono text not null,
    
    constraint configuracion_zonas_pkey primary key (id),
    constraint configuracion_zonas_fk_id_zona_fkey foreign key (fk_id_zona) 
        references public.zonas (id) on delete cascade
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador √∫nico autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creaci√≥n
- `fk_id_zona` (BIGINT, FK): Referencia a zona
- `telefono` (TEXT): Tel√©fono espec√≠fico de la zona

---

## üìà √çndices

### √çndices de rendimiento para productos
```sql
-- √çndices para productos
CREATE INDEX productos_activo_idx ON public.productos (activo);
CREATE INDEX productos_destacado_idx ON public.productos (destacado);
CREATE INDEX productos_fk_id_categoria_idx ON public.productos (fk_id_categoria);
CREATE INDEX productos_fk_id_marca_idx ON public.productos (fk_id_marca);
CREATE INDEX productos_aplica_todos_plan_idx ON public.productos (aplica_todos_plan);
CREATE INDEX productos_aplica_solo_categoria_idx ON public.productos (aplica_solo_categoria);
CREATE INDEX productos_aplica_plan_especial_idx ON public.productos (aplica_plan_especial);

-- √çndices para im√°genes (solo cuando no son nulas)
CREATE INDEX productos_imagen_idx ON public.productos (imagen) WHERE imagen IS NOT NULL;
CREATE INDEX productos_imagen_2_idx ON public.productos (imagen_2) WHERE imagen_2 IS NOT NULL;
CREATE INDEX productos_imagen_3_idx ON public.productos (imagen_3) WHERE imagen_3 IS NOT NULL;
CREATE INDEX productos_imagen_4_idx ON public.productos (imagen_4) WHERE imagen_4 IS NOT NULL;
CREATE INDEX productos_imagen_5_idx ON public.productos (imagen_5) WHERE imagen_5 IS NOT NULL;
```

### √çndices para planes de financiaci√≥n
```sql
CREATE INDEX planes_financiacion_activo_idx ON public.planes_financiacion (activo);
CREATE INDEX planes_financiacion_cuotas_idx ON public.planes_financiacion (cuotas);
CREATE INDEX planes_financiacion_monto_minimo_idx ON public.planes_financiacion (monto_minimo);
```

### √çndices para tablas relacionales
```sql
-- Planes-Categor√≠as
CREATE INDEX planes_categorias_fk_id_plan_idx ON public.planes_categorias (fk_id_plan);
CREATE INDEX planes_categorias_fk_id_categoria_idx ON public.planes_categorias (fk_id_categoria);

-- Productos-Planes
CREATE INDEX productos_planes_fk_id_producto_idx ON public.productos_planes (fk_id_producto);
CREATE INDEX productos_planes_fk_id_plan_idx ON public.productos_planes (fk_id_plan);
CREATE INDEX productos_planes_activo_idx ON public.productos_planes (activo);
CREATE INDEX productos_planes_destacado_idx ON public.productos_planes (destacado);

-- Productos-Planes-Default
CREATE INDEX productos_planes_default_fk_id_producto_idx ON public.productos_planes_default (fk_id_producto);
CREATE INDEX productos_planes_default_fk_id_plan_idx ON public.productos_planes_default (fk_id_plan);
CREATE INDEX productos_planes_default_activo_idx ON public.productos_planes_default (activo);

-- Configuraci√≥n Zonas
CREATE INDEX configuracion_zonas_fk_id_zona_idx ON public.configuracion_zonas (fk_id_zona);
```

---

## ‚öôÔ∏è Funciones y Triggers

### Funci√≥n para actualizar timestamp autom√°ticamente
```sql
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

### Triggers para actualizar updated_at autom√°ticamente
```sql
-- Trigger para planes_financiacion
CREATE TRIGGER update_planes_financiacion_updated_at 
    BEFORE UPDATE ON public.planes_financiacion
    FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
```

---

## üîí Row Level Security (RLS)

### Habilitar RLS en todas las tablas
```sql
-- Habilitar RLS en todas las tablas principales
ALTER TABLE public.categorias ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.marcas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.planes_financiacion ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.planes_categorias ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos_planes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos_planes_default ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.zonas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configuracion ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configuracion_zonas ENABLE ROW LEVEL SECURITY;
```

---

## üõ°Ô∏è Pol√≠ticas de Seguridad

### Pol√≠ticas para todas las tablas (acceso p√∫blico para lectura)
```sql
-- CATEGORIAS
CREATE POLICY "Permitir acceso completo a categorias" 
    ON public.categorias FOR ALL USING (true);

-- MARCAS
CREATE POLICY "Permitir acceso completo a marcas" 
    ON public.marcas FOR ALL USING (true);

-- PRODUCTOS
CREATE POLICY "Permitir acceso completo a productos" 
    ON public.productos FOR ALL USING (true);

-- PLANES_FINANCIACION
CREATE POLICY "Permitir acceso completo a planes_financiacion" 
    ON public.planes_financiacion FOR ALL USING (true);

-- PLANES_CATEGORIAS
CREATE POLICY "Permitir acceso completo a planes_categorias" 
    ON public.planes_categorias FOR ALL USING (true);

-- PRODUCTOS_PLANES
CREATE POLICY "Permitir acceso completo a productos_planes" 
    ON public.productos_planes FOR ALL USING (true);

-- PRODUCTOS_PLANES_DEFAULT
CREATE POLICY "Permitir acceso completo a productos_planes_default" 
    ON public.productos_planes_default FOR ALL USING (true);

-- ZONAS
CREATE POLICY "Permitir acceso completo a zonas" 
    ON public.zonas FOR ALL USING (true);

-- CONFIGURACION
CREATE POLICY "Permitir acceso completo a configuracion" 
    ON public.configuracion FOR ALL USING (true);

-- CONFIGURACION_ZONAS
CREATE POLICY "Permitir acceso completo a configuracion_zonas" 
    ON public.configuracion_zonas FOR ALL USING (true);
```

---

## üì¶ Storage Buckets

### Bucket de im√°genes
```sql
-- Crear bucket de im√°genes
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'imagenes',
    'imagenes',
    true,
    5242880, -- 5MB en bytes
    ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
) ON CONFLICT (id) DO NOTHING;
```

### Pol√≠ticas de Storage
```sql
-- Pol√≠tica para subir archivos (p√∫blico)
CREATE POLICY "Permitir subir im√°genes p√∫blicamente" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'imagenes');

-- Pol√≠tica para ver archivos (p√∫blico)
CREATE POLICY "Permitir ver im√°genes p√∫blicamente" ON storage.objects
FOR SELECT USING (bucket_id = 'imagenes');

-- Pol√≠tica para actualizar archivos (p√∫blico)
CREATE POLICY "Permitir actualizar im√°genes p√∫blicamente" ON storage.objects
FOR UPDATE USING (bucket_id = 'imagenes');

-- Pol√≠tica para eliminar archivos (p√∫blico)
CREATE POLICY "Permitir eliminar im√°genes p√∫blicamente" ON storage.objects
FOR DELETE USING (bucket_id = 'imagenes');
```

### Estructura de carpetas en Storage
```
Bucket: imagenes/
‚îú‚îÄ‚îÄ productos/          # Im√°genes de productos
‚îÇ   ‚îú‚îÄ‚îÄ abc123.jpg
‚îÇ   ‚îú‚îÄ‚îÄ def456.png
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ logos/              # Logos de marcas
    ‚îú‚îÄ‚îÄ marca1.png
    ‚îú‚îÄ‚îÄ marca2.jpg
    ‚îî‚îÄ‚îÄ ...
```

---

## üìÑ Comentarios en Tablas

```sql
-- Comentarios para documentaci√≥n
COMMENT ON TABLE public.categorias IS 'Categor√≠as de productos disponibles';
COMMENT ON TABLE public.marcas IS 'Marcas de productos con logos opcionales';
COMMENT ON TABLE public.productos IS 'Cat√°logo principal de productos con m√∫ltiples im√°genes';
COMMENT ON TABLE public.planes_financiacion IS 'Planes de financiaci√≥n con diferentes configuraciones';
COMMENT ON TABLE public.planes_categorias IS 'Relaci√≥n muchos-a-muchos entre planes y categor√≠as';
COMMENT ON TABLE public.productos_planes IS 'Productos asignados manualmente a planes espec√≠ficos';
COMMENT ON TABLE public.productos_planes_default IS 'Asociaciones autom√°ticas por reglas de negocio';
COMMENT ON TABLE public.zonas IS 'Zonas geogr√°ficas para configuraci√≥n regional';
COMMENT ON TABLE public.configuracion IS 'Configuraci√≥n general del sistema';
COMMENT ON TABLE public.configuracion_zonas IS 'Configuraci√≥n espec√≠fica por zona geogr√°fica';
```

---

## üìä Datos de Ejemplo

### Categor√≠as de ejemplo
```sql
INSERT INTO public.categorias (descripcion) VALUES
    ('Smartphones'),
    ('Tablets'),
    ('Laptops'),
    ('Accesorios'),
    ('Audio'),
    ('Gaming');
```

### Marcas de ejemplo
```sql
INSERT INTO public.marcas (descripcion, logo) VALUES
    ('Apple', 'https://ejemplo.com/logos/apple.png'),
    ('Samsung', 'https://ejemplo.com/logos/samsung.png'),
    ('Xiaomi', 'https://ejemplo.com/logos/xiaomi.png'),
    ('Lenovo', 'https://ejemplo.com/logos/lenovo.png'),
    ('Sony', 'https://ejemplo.com/logos/sony.png');
```

### Planes de financiaci√≥n de ejemplo
```sql
INSERT INTO public.planes_financiacion (nombre, cuotas, recargo_porcentual, monto_minimo, activo) VALUES
    ('Plan 3 Cuotas', 3, 0.00, 50000.00, true),
    ('Plan 6 Cuotas', 6, 15.00, 100000.00, true),
    ('Plan 12 Cuotas', 12, 25.00, 200000.00, true),
    ('Plan 18 Cuotas', 18, 35.00, 300000.00, true),
    ('Plan 24 Cuotas', 24, 45.00, 500000.00, true);
```

---

## üöÄ Orden de Migraci√≥n

Para migrar la base de datos, ejecutar en este orden:

1. **Extensiones y configuraci√≥n b√°sica**
2. **Tablas base** (categorias, marcas)
3. **Tablas principales** (productos, planes_financiacion)
4. **Tablas relacionales** (planes_categorias, productos_planes, etc.)
5. **Tablas de configuraci√≥n** (zonas, configuracion, configuracion_zonas)
6. **√çndices**
7. **Funciones y triggers**
8. **RLS y pol√≠ticas de seguridad**
9. **Storage buckets y pol√≠ticas**
10. **Datos de ejemplo** (opcional)

---

## ‚ö†Ô∏è Notas Importantes

- **RLS est√° habilitado** con pol√≠ticas permisivas para desarrollo
- **Todas las tablas usan BIGINT** como clave primaria autoincremental
- **Storage p√∫blico** configurado para im√°genes hasta 5MB
- **M√∫ltiples im√°genes por producto** (hasta 5 im√°genes)
- **Descripci√≥n detallada soporta HTML** para formato enriquecido
- **Sistema de planes flexible** con recargas porcentuales o fijas
- **Asociaciones autom√°ticas y manuales** entre productos y planes
- **Configuraci√≥n por zonas** para soporte regional

---

üìÖ **Fecha de creaci√≥n:** $(date)  
üîÑ **Versi√≥n:** 1.0  
üë§ **Generado por:** Claude Code Assistant